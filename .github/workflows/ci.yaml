name: CI

on:
  pull_request:
    branches: [main]

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      config: ${{ steps.filter.outputs.config }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for code changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - '.github/workflows/ci.yaml'
              - 'Makefile'
              - 'Taskfile.yaml'
            config:
              - 'internal/config/**'
              - 'cmd/genschema/**'

  schema-check:
    name: Schema Verification
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.config == 'true' || needs.changes.outputs.code == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Generate schema
        run: go run ./cmd/genschema --output=kindplane.schema.json.new

      - name: Verify schema is up-to-date
        run: |
          if [ -f kindplane.schema.json ]; then
            if ! diff -q kindplane.schema.json kindplane.schema.json.new > /dev/null 2>&1; then
              echo "::error::Schema is out of date. Run 'task schema:generate' to regenerate."
              echo "Diff:"
              diff kindplane.schema.json kindplane.schema.json.new || true
              exit 1
            else
              echo "âœ“ Schema is up-to-date"
            fi
          else
            echo "::warning::kindplane.schema.json not found in repository. This is expected for new repositories."
          fi

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.code == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [changes, test]
    if: needs.changes.outputs.code == 'true'
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "none")
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          go build -ldflags="-s -w -X main.Version=${VERSION} -X main.Commit=${COMMIT} -X main.BuildTime=${BUILD_TIME}" -o kindplane-${GOOS}-${GOARCH}${EXT} ./cmd/kindplane

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kindplane-${{ matrix.goos }}-${{ matrix.goarch }}
          path: kindplane-*

  # This job always runs and reports CI status
  # Use this as your required check in branch protection
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [changes, schema-check, test, build]
    if: always()
    steps:
      - name: Check CI status
        run: |
          echo "Changes result: ${{ needs.changes.result }}"
          echo "Changes detected: ${{ needs.changes.outputs.code }}"
          echo "Config changes detected: ${{ needs.changes.outputs.config }}"
          echo "Schema check result: ${{ needs.schema-check.result }}"
          echo "Test result: ${{ needs.test.result }}"
          echo "Build result: ${{ needs.build.result }}"

          # First, verify the change detection job succeeded
          if [[ "${{ needs.changes.result }}" != "success" ]]; then
            echo "::error::Change detection job failed with result: ${{ needs.changes.result }}"
            exit 1
          fi

          # If no code changes, CI passes (jobs were skipped)
          if [[ "${{ needs.changes.outputs.code }}" != "true" ]]; then
            echo "No code changes detected - CI skipped"
            exit 0
          fi

          # If config changed, check that schema verification passed
          if [[ "${{ needs.changes.outputs.config }}" == "true" ]]; then
            if [[ "${{ needs.schema-check.result }}" == "failure" || "${{ needs.schema-check.result }}" == "cancelled" ]]; then
              echo "Schema verification failed"
              exit 1
            fi
          fi

          # If code changed, check that test and build passed
          if [[ "${{ needs.changes.outputs.code }}" == "true" ]]; then
            if [[ "${{ needs.test.result }}" == "failure" || "${{ needs.test.result }}" == "cancelled" ]]; then
              echo "Test job failed"
              exit 1
            fi

            if [[ "${{ needs.build.result }}" == "failure" || "${{ needs.build.result }}" == "cancelled" ]]; then
              echo "Build job failed"
              exit 1
            fi
          fi

          echo "CI passed"
