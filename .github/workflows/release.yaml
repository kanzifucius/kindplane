name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binaries
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          COMMIT=${{ github.sha }}
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          LDFLAGS="-s -w -X github.com/kanzi/kindplane/internal/cmd.version=${VERSION} -X github.com/kanzi/kindplane/internal/cmd.commit=${COMMIT} -X github.com/kanzi/kindplane/internal/cmd.buildTime=${BUILD_TIME}"
          
          # Linux AMD64
          GOOS=linux GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/kindplane-linux-amd64 ./cmd/kindplane
          
          # Linux ARM64
          GOOS=linux GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/kindplane-linux-arm64 ./cmd/kindplane
          
          # macOS AMD64
          GOOS=darwin GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/kindplane-darwin-amd64 ./cmd/kindplane
          
          # macOS ARM64 (Apple Silicon)
          GOOS=darwin GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/kindplane-darwin-arm64 ./cmd/kindplane
          
          # Windows AMD64
          GOOS=windows GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/kindplane-windows-amd64.exe ./cmd/kindplane

      - name: Create checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create tarballs
        run: |
          cd dist
          VERSION=${{ steps.version.outputs.VERSION }}
          
          # Create tarballs for Unix systems
          for f in kindplane-linux-* kindplane-darwin-*; do
            tar -czvf "${f}-${VERSION}.tar.gz" "$f"
          done
          
          # Create zip for Windows
          zip "kindplane-windows-amd64-${VERSION}.zip" kindplane-windows-amd64.exe
          
          # Update checksums with archives
          sha256sum *.tar.gz *.zip >> checksums.txt

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREV_TAG}..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" HEAD)
          fi
          
          # Write to file for multiline support
          echo "$CHANGELOG" > changelog.txt
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
          generate_release_notes: true
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
          body: |
            ## Installation
            
            ### Quick Install (Linux/macOS)
            
            ```bash
            curl -fsSL https://raw.githubusercontent.com/kanzifucius/kindplane/main/install.sh | bash
            ```
            
            ### Manual Download
            
            Download the appropriate binary for your system from the assets below.
            
            ### Checksums
            
            Verify your download with the checksums in `checksums.txt`.
            
            ## What's Changed
            
            See the auto-generated release notes below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-install-script:
    name: Update Install Script
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update install script version
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          sed -i "s/^VERSION=.*/VERSION=\"${VERSION}\"/" install.sh
          
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add install.sh
          git diff --staged --quiet || git commit -m "chore: update install.sh to ${{ steps.version.outputs.VERSION }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
